<!--
    Editing and Translation Coordination tool
    Copyright (C) 2023-2024, Moshe Sambol, https://github.com/mjsambol

    Originally created for the Tamtzit Hachadashot project
    of the Lokhim Ahrayut non-profit organization
    Published in English as "Israel News Highlights"

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published
    by the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->

<html>
    <head>
        <title>Tamtzit - Hebrew Editing</title>
        <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.png') }}">
        <script src="{{url_for('static', filename='tamtzit-common.js', version='20240808')}}"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

        <script>
            const TEXT_BEING_EDITED = "heb_text";
            const LENGTH_LABEL = "××•×¨×š:";
            const CHARACTERS_LABEL = "××•×ª×™×•×ª";

            var user_role = "{{user_role}}"; // required for the status box
            var dont_remove_footer = "True" === "{{user_info['overrides'] is defined and 'dont_remove_footer' in user_info['overrides']}}";

            function updatePreview() {
                update_char_count();
                document.getElementById("preview_panel").innerHTML=makeWhatsappPreview(document.getElementById("heb_text").value);
            }

            var last_saved_text = `{{heb_text}}`;
            var is_finished = "True" === "{{is_finished}}";
            var ok_to_translate = "True" === "{{ok_to_translate}}";

            function done() {
                disable_done_button();
                is_finished = true;
                saveDraft(force=true);
            }

            function disable_done_button() {
                document.getElementById("done_button").style.backgroundColor="#66BB66";
                document.getElementById("done_button").disabled = true;
                document.getElementById("heb_text").disabled = true;
     //           document.getElementById("back_home").style.visibility = "visible";
                document.getElementById("edit_anyway_button").style.visibility = "visible";
            }

            function disable_send_to_translators() {
                document.getElementById("to_translation_button").style.backgroundColor="#66BB66";
                document.getElementById("to_translation_button").disabled = true;
                // document.getElementById("done_button").disabled = false;    // why is this here? Commenting this out 2024-05-16
            }

            function observe_only() {
                document.getElementById("to_translation_button").disabled = true;
                document.getElementById("done_button").disabled = true;
                document.getElementById("heb_text").disabled = true;
       //         document.getElementById("back_home").style.visibility = "visible";
                document.getElementById("edit_anyway_button").style.visibility = "visible";
            }

            function enable_edit() {
                document.getElementById("heb_text").disabled = false;
                document.getElementById("edit_anyway_button").style.visibility = "hidden";
                if (ok_to_translate) { 
                    if (user_role.includes("editor") || user_role.includes("admin")) {
                        document.getElementById("done_button").style.backgroundColor="#DDDDDD";
                        document.getElementById("done_button").disabled = false;
                    }
                    if (user_role.includes("editor") && document.getElementById("heb_text").value.includes("×¢×¨×™×›×” ×œ×©×•× ×™×ª: ×¢×•×“ ×œ× ×™×“×•×¢")) {
                        document.getElementById("heb_text").value = 
                            document.getElementById("heb_text").value.replace("×¢×¨×™×›×” ×œ×©×•× ×™×ª: ×¢×•×“ ×œ× ×™×“×•×¢", "×¢×¨×™×›×” ×œ×©×•× ×™×ª: {{editor_user_name}}");
                    }
                } else {
                    document.getElementById("to_translation_button").disabled = false;
                    document.getElementById("to_translation_button").style.backgroundColor="#DDDDDD";
                }
        //        document.getElementById("back_home").style.visibility = "hidden";
            }

            function to_translators() {
                disable_send_to_translators();
                observe_only();
                ok_to_translate = true;
                saveDraft(force=true);
                
                if ("{{req_rule}}".indexOf("daily_summary") == -1 &&
                    ((("{{date_info.day_of_week_digit}}"=="5") && ("{{date_info.part_of_day}}" == "×¦×•×”×¨×™×™×"))  || 
                     (("{{date_info.day_of_week_digit}}"!="6") && ("{{date_info.part_of_day}}" == "×¢×¨×‘")))) {
                    document.location = "/start_daily_summary";
                } else {
                    document.location = "/";
                }
            }

            function translation_changed() {
                if (last_saved_text.localeCompare(document.getElementById('heb_text').value) != 0) {
                        document.getElementById("is_saved").innerText = "×”×©×™× ×•×™×™× ×¢×•×“ ×œ× ×©××•×¨×™×!";
                        document.getElementById("is_saved").style.color = "#FF0000";
                        document.getElementById("finish_button").innerText = "×”×¢×ª×§ ××ª ×›×œ ×”×ª×•×›×Ÿ";
                        is_finished = false;
                } 
            }

            function saveDraft(force=false) {
                if (is_finished && !force) {
                    return;
                }
                curr_text = document.getElementById('heb_text').value;
                if (force || last_saved_text.localeCompare(curr_text) != 0) {
                    console.log("saving, text was\n\n"+last_saved_text+"\n\ntext is now\n\n" + curr_text);
                    $.post("/saveDraft",
                    {
                        draft_key: "{{draft_key}}",
                        source_text: curr_text,
                        is_finished: is_finished,
                        to_translators: ok_to_translate
                    },
                    function(data,status) {
                        console.log("Draft save status: " + status);
                        last_saved_text = curr_text;
                        if (status === "success") {
                            document.getElementById("is_saved").innerText = "×›×œ ×”×©×™× ×•×™×™× ×©××•×¨×™×";
                            document.getElementById("is_saved").style.color = "#33AA33";
                        }
                    });
                }
            }

            setInterval(function(){saveDraft()}, 10000);  // automatically save a draft every 30 seconds, if the text has changed


        </script>
    </head>
    <body align="center">
        
        <table width="100%" border="0" cellspacing="10">
            <tr>
                <td width="40%" valign="top" id="preview_panel" style="font-size:20px;" dir="rtl"> </td>
                <td width="60%" valign="top" id="orig_heb_panel">

        <textarea id="heb_text" style="font-size:22px;" name="orig_text" rows="30" cols="70" dir="rtl" oninput="updatePreview();translation_changed();">
{%if heb_text | length > 0 %}{{ heb_text }}{% else 
%}{{ header }}{% 
if heb_text_body_only | length > 0 %}{{ heb_text_body_only }}{% else 
%}ğŸ“Œ *_××œ×—××ª ×—×¨×‘×•×ª ×‘×¨×–×œ:_*

> *×”×—×–×™×ª ×”×¦×¤×•× ×™×ª:*
- 

- 

> *×”×—×–×™×ª ×”×“×¨×•××™×ª:*
- 

- 

> *×—×–×™×ª ××™×•"×©:*
- 

- 

ğŸ“Œ *_×‘×™×˜×—×•×Ÿ:_*
â€¢ 

â€¢ 

ğŸ“Œ *_××”××ª×¨×—×© ×‘××¨×¥:_*
â€¢ 

â€¢ 

ğŸ“Œ *_××“×™× ×™×•×ª, ××©×¤×˜ ×•×¤×•×œ×™×˜×™×§×”:_*
â€¢ 

â€¢ 

ğŸ“Œ *_××¡×‘×™×‘ ×œ×¢×•×œ×:_*
â€¢ 

ğŸ“Œ *_×›×œ×›×œ×”:_*
â€¢ 

ğŸ“Œ *_×¡×¤×•×¨×˜:_*
â€¢ 

ğŸ“Œ *_××–×’ ×”××•×•×™×¨:_*
â€¢ 

ğŸ“Œ *_×•× ×¡×™×™× ×‘×˜×•×‘:_*
â€¢ 

{% endif %}â€¢   â€¢   â€¢

×›×ª×™×‘×”: {{author_user_name}}. ×¢×¨×™×›×” ×œ×©×•× ×™×ª: {{editor_user_name}}.
{{ footer }}{% endif %}</textarea>

<table width=100%>
    <tr>
        <td width="33%" align="right"><span id="is_saved" dir="rtl"></span></td>
        <td width="33%" align="right"><span id="char_count" dir="rtl">××•×¨×š: X ××•×ª×™×•×ª</span></td>
        <td width="33%"></td>
    </tr>
</table>
<table width="100%">
    <tr>
        <td width="33%" align="center">
            <button id="finish_button" style="font-size: 20px; padding:8px 8px" onclick="copyToClipboard('heb_text');">×”×¢×ª×§ ××ª ×›×œ ×”×ª×•×›×Ÿ</button>
        </td>
        <td width="33%" align="center">
            <button id="edit_anyway_button" style="font-size: 15px; padding:3px 3px;visibility: hidden;" onclick="enable_edit();">×¢×¨×•×š ×©×•×‘</button>&nbsp;&nbsp;&nbsp;
            <button id="back_home" style="font-size: 20px; padding:8px 8px;" onclick="window.location='/';">×—×–×¨×” ×œ×”×ª×—×œ×”</button>&nbsp;&nbsp;
            <button id="done_button" style="font-size: 20px; padding:8px 8px;" disabled="true" onclick="done();">××•×›×Ÿ ×œ×©×œ×™×—×”</button>            
            </td>
        <td width="33%" align="center">
            <button id="to_translation_button" style="font-size: 20px; padding:8px 8px;" onclick="to_translators();">××•×›×Ÿ ×œ×¢×¨×™×›×”</button>  
            <br>
        </td>
    </tr>
</table>

    </td></tr></table>

{% if ok_to_translate %}
    <script>
        disable_send_to_translators();
    </script>
{% endif %}
{% if is_finished %}
    <script>
        disable_done_button();
        document.getElementById("edit_anyway_button").style.visibility = "visible";
    </script>
{% endif %}
{% if in_progress %}
<script>
    observe_only();
</script>
{% endif %}
    <script>
        update_char_count();
    </script>
</body>
</html>